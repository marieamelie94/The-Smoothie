<div class="container">
  <h1>Configure Your Basket</h1>
  <div class="selected-smoothies">
    <h3>Your selected smoothies:</h3>
    <div class="selected-smoothie__summary">
      <ul id="selected-smoothie-list" class="list-group">
        No items yet...
      </ul>
    </div>
    <div>
      total amount: 12 euro
    </div>

  </div>
  <%= simple_form_for :order, url: order_add_items_path(@order) do |form| %>

  <div class="smoothies">
    <% @smoothies.each do |smoothie| %>

    <div class="smoothie">
      <img src="<%= smoothie.photo %>" alt="" width ="150" height="120">

      <%= form.simple_fields_for :order_items do |s| %>
      <h3><%=smoothie.name%></h3>

      <div class="smoothie__amount">
        <% key = "smoothie_quantity" + smoothie.id.to_s %>
        <%= s.input key.to_sym, selected: 0, collection: (0..7), label: "Quantity", required: false %>
      </div>
      <% end %>
      <div class="btn btn-default" data-toggle="modal" data-target='<%= "#detox_description_#{smoothie.id}" %>'>Details</div>
    </div>
    <% end %>
  </div>
  <%= form.submit "Order", class: "btn btn-lg btn-center btn-success" %>
  <% end %>
</div>


<% @smoothies.each do |smoothie| %>
<div class="modal fade" id='<%= "detox_description_#{smoothie.id}" %>' tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">

        <h5 class="modal-title" id="exampleModalLabel"><%=smoothie.name%></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <%= smoothie.description %>
        <div class="smoothie__ingredients">
          <h2 class="smoothie__ingredients__title">Ingredients</h2>
          <% smoothie.doses.each do |d| %>
          <div class="smoothie__ingredient">
            <%= d.ingredient.name %> <%= d.value%><%= d.unit%>
          </div>
          <% end %>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>

    </div>
  </div>
</div>
</div>
<% end %>
<script>
  const totalSmoothies = <%= raw @smoothies.all().to_json %>;
  let selectedSmoothies = {};

  totalSmoothies.forEach((smoothie, index) => {
    const smoothieAmount = document.getElementById(
      `order_order_items_smoothie_quantity${index + 1}`
    );

    smoothieAmount.addEventListener("change", (event) => {
      event.preventDefault();
      (event.target.value === '0')
        ? delete selectedSmoothies[smoothie.name]
        : selectedSmoothies[smoothie.name] = event.target.value;

      const selectedSmoothieList = document.getElementById(
        'selected-smoothie-list'
      );

      while (selectedSmoothieList.firstChild) {
        selectedSmoothieList.removeChild(selectedSmoothieList.firstChild);
      }

      Object.keys(selectedSmoothies).forEach(smoothieName => {
        const listItem = document.createElement('li');
        listItem.className = "list-group-item";
        listItem.innerHTML = `
          <span class="badge">
            ${selectedSmoothies[smoothieName]}
          </span>
          ${smoothieName}
        `;
        selectedSmoothieList.appendChild(listItem);
      });
    });
  });
</script>
